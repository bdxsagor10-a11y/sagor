<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SAGOR HUB Mini App</title>
    
    <!-- Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Fonts & Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            /* Telegram Theme Integration */
            --tg-bg: var(--tg-theme-bg-color, #f8f9fa);
            --tg-text: var(--tg-theme-text-color, #1a1a1a);
            --tg-hint: var(--tg-theme-hint-color, #8e8e93);
            --tg-link: var(--tg-theme-link-color, #007aff);
            --tg-button: var(--tg-theme-button-color, #007aff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            
            --card-radius: 16px;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Urbanist', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--tg-bg); color: var(--tg-text); padding-bottom: 90px; min-height: 100vh; overflow-x: hidden; transition: 0.3s; }
        
        /* Helpers */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Loader */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--tg-bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--tg-hint); border-top-color: var(--tg-button); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Header */
        .app-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--tg-bg); z-index: 100; backdrop-filter: blur(10px); }
        .brand { font-size: 20px; font-weight: 800; background: linear-gradient(45deg, var(--tg-link), #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .user-badge { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; background: var(--tg-secondary-bg); padding: 5px 12px; border-radius: 50px; box-shadow: var(--shadow); }

        /* Search */
        .search-area { padding: 10px 20px; }
        .search-box { background: var(--tg-secondary-bg); border-radius: 12px; padding: 12px 15px; display: flex; align-items: center; gap: 10px; box-shadow: var(--shadow); }
        .search-box input { border: none; background: transparent; width: 100%; outline: none; color: var(--tg-text); font-size: 15px; }

        /* Sliders */
        .slider-section { padding: 15px 20px; }
        .slider-wrapper { width: 100%; aspect-ratio: 16/9; border-radius: var(--card-radius); overflow: hidden; position: relative; box-shadow: var(--shadow); background: var(--tg-hint); }
        .slide { width: 100%; height: 100%; object-fit: cover; position: absolute; opacity: 0; transition: 0.5s; }
        .slide.active { opacity: 1; }

        /* Grid Items */
        .section-title { padding: 10px 20px 5px; font-size: 17px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px 20px; }
        .card { background: var(--tg-secondary-bg); border-radius: var(--card-radius); overflow: hidden; box-shadow: var(--shadow); position: relative; transition: transform 0.2s; }
        .card:active { transform: scale(0.98); }
        .card-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; }
        .card-content { padding: 12px; }
        .card-title { font-size: 14px; font-weight: 700; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tag { font-size: 10px; background: var(--tg-button); color: var(--tg-button-text); padding: 3px 8px; border-radius: 4px; font-weight: 600; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; background: rgba(255,255,255,0.85); backdrop-filter: blur(15px); border-radius: 20px; display: flex; justify-content: space-around; padding: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); z-index: 1000; border: 1px solid rgba(255,255,255,0.3); }
        /* Dark mode nav adjust */
        @media (prefers-color-scheme: dark) { .bottom-nav { background: rgba(30,30,30,0.85); border-color: rgba(255,255,255,0.1); } }
        
        .nav-item { font-size: 22px; color: var(--tg-hint); padding: 10px; border-radius: 12px; transition: 0.3s; position: relative; }
        .nav-item.active { color: var(--tg-button); background: var(--tg-secondary-bg); box-shadow: 0 4px 10px rgba(0,0,0,0.05); transform: translateY(-5px); }

        /* Details Page */
        .detail-hero { width: 100%; border-radius: 20px; margin-bottom: 20px; box-shadow: var(--shadow); border: 2px solid var(--tg-secondary-bg); }
        .btn { width: 100%; padding: 16px; border-radius: 14px; border: none; font-weight: 700; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 12px; transition: 0.2s; }
        .btn-primary { background: var(--tg-button); color: var(--tg-button-text); box-shadow: 0 8px 20px -5px rgba(0,122,255,0.4); }
        .btn-outline { background: transparent; border: 2px solid var(--tg-button); color: var(--tg-button); }
        .btn:active { transform: scale(0.97); }

        /* Auth Screen */
        .auth-container { height: 90vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; text-align: center; }
        .auth-input { width: 100%; padding: 15px; background: var(--tg-secondary-bg); border: 1px solid var(--tg-hint); border-radius: 12px; margin-bottom: 15px; color: var(--tg-text); outline: none; }

        /* Custom Page */
        .upload-btn { display: block; text-align: center; padding: 15px; border: 2px dashed var(--tg-hint); border-radius: 12px; color: var(--tg-hint); margin-bottom: 20px; text-decoration: none; font-weight: 600; }

        /* Key Viewer (Pop-up Style) */
        .key-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--tg-bg); z-index: 5000; display: flex; flex-direction: column; justify-content: center; padding: 30px; }
        .key-card { background: var(--tg-secondary-bg); padding: 30px; border-radius: 24px; text-align: center; box-shadow: var(--shadow); }
        .password-box { background: var(--tg-bg); padding: 15px; border-radius: 10px; font-family: monospace; font-size: 20px; letter-spacing: 2px; margin: 20px 0; border: 1px dashed var(--tg-button); }

    </style>
</head>
<body>

    <!-- LOADER -->
    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-weight: 600; color: var(--tg-hint);">Loading App...</p>
    </div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav" id="nav-bar">
        <div class="nav-item active" onclick="nav('home')"><i class="fas fa-home"></i></div>
        <div class="nav-item" onclick="nav('custom')"><i class="fas fa-gift"></i></div>
        <div class="nav-item" onclick="nav('profile')"><i class="fas fa-user"></i></div>
    </div>

    <!-- 1. AUTH SCREEN (Fallback for Browser) -->
    <div id="view-auth" class="auth-container hidden">
        <h2 style="margin-bottom: 10px; color: var(--tg-button);">Welcome Back</h2>
        <p style="margin-bottom: 30px; color: var(--tg-hint);">Please login to continue</p>
        
        <div id="tg-login-status" class="hidden" style="color: #22c55e; margin-bottom: 20px; font-weight: 600;">
            <i class="fab fa-telegram"></i> Telegram Detected. Logging in...
        </div>

        <div id="manual-login">
            <input type="email" id="login-email" class="auth-input" placeholder="Email">
            <input type="password" id="login-pass" class="auth-input" placeholder="Password">
            <button class="btn btn-primary" onclick="manualLogin()">Login</button>
            <button class="btn btn-outline" onclick="toggleReg()">Create Account</button>
        </div>

        <div id="manual-reg" class="hidden">
            <input type="email" id="reg-email" class="auth-input" placeholder="New Email">
            <input type="password" id="reg-pass" class="auth-input" placeholder="New Password">
            <button class="btn btn-primary" onclick="manualRegister()">Register</button>
            <button class="btn btn-outline" onclick="toggleReg()">Back to Login</button>
        </div>
    </div>

    <!-- 2. HOME SCREEN -->
    <div id="view-home" class="fade-in hidden">
        <div class="app-header">
            <div class="brand">SAGOR HUB</div>
            <div class="user-badge"><i class="fas fa-check-circle" style="color:#22c55e;"></i> <span id="header-name">User</span></div>
        </div>

        <div class="search-area">
            <div class="search-box">
                <i class="fas fa-search" style="color: var(--tg-hint);"></i>
                <input type="text" id="search-input" placeholder="Search items..." onkeyup="filterItems()">
            </div>
        </div>

        <div class="slider-section">
            <div class="slider-wrapper" id="slider-box"></div>
        </div>

        <div class="section-title">
            <span>Latest Drops</span>
            <i class="fas fa-fire" style="color: #f59e0b;"></i>
        </div>
        
        <div class="grid" id="item-grid">
            <!-- Items will load here -->
        </div>
    </div>

    <!-- 3. DETAILS SCREEN -->
    <div id="view-details" class="fade-in hidden" style="padding: 20px;">
        <div style="margin-bottom: 20px;" onclick="nav('home')">
            <i class="fas fa-arrow-left" style="font-size: 20px;"></i>
        </div>
        
        <img id="dt-img" class="detail-hero">
        <h2 id="dt-title" style="line-height: 1.3; margin-bottom: 10px;">Item Title</h2>
        
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <span class="tag" style="padding: 6px 12px; font-size: 12px;" id="dt-ver">v1.0</span>
            <span class="tag" style="padding: 6px 12px; font-size: 12px; background: var(--tg-hint);" id="dt-owner">Admin</span>
        </div>

        <button class="btn btn-primary" onclick="openPremium()"><i class="fas fa-crown"></i> Premium Download</button>
        <button class="btn btn-outline" onclick="openDownloads()"><i class="fas fa-download"></i> Free Download</button>

        <div style="background: var(--tg-secondary-bg); padding: 20px; border-radius: 16px; margin-top: 25px; box-shadow: var(--shadow);">
            <h4 style="margin-bottom: 10px;">Description</h4>
            <p id="dt-desc" style="color: var(--tg-hint); font-size: 14px; line-height: 1.6;">...</p>
        </div>
    </div>

    <!-- 4. DOWNLOAD LINKS SCREEN -->
    <div id="view-downloads" class="fade-in hidden" style="padding: 20px; text-align: center;">
        <div style="margin-bottom: 20px; text-align: left;" onclick="nav('details')">
            <i class="fas fa-arrow-left" style="font-size: 20px;"></i>
        </div>
        <h3 style="margin-bottom: 20px;">Select Link</h3>
        <div id="dl-btn-container"></div>
    </div>

    <!-- 5. PROFILE SCREEN -->
    <div id="view-profile" class="fade-in hidden" style="padding: 40px 20px; text-align: center;">
        <div style="width: 100px; height: 100px; background: var(--tg-secondary-bg); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 40px; color: var(--tg-button); box-shadow: var(--shadow);">
            <i class="fas fa-user"></i>
        </div>
        <h2 id="prof-name">User</h2>
        <p id="prof-id" style="color: var(--tg-hint); font-size: 14px; margin-bottom: 30px;">ID: --</p>
        
        <div style="background: var(--tg-secondary-bg); border-radius: 16px; overflow: hidden; margin-bottom: 20px;">
            <div style="padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); text-align: left;">
                <i class="fas fa-history" style="width: 25px;"></i> History
            </div>
            <div style="padding: 15px; text-align: left; cursor: pointer;" onclick="window.open('https://t.me/SagorHubSupport')">
                <i class="fas fa-headset" style="width: 25px;"></i> Support
            </div>
        </div>

        <button class="btn" style="background: #ff3b30; color: white;" onclick="logout()">Logout</button>
    </div>

    <!-- 6. CUSTOM REQUEST SCREEN -->
    <div id="view-custom" class="fade-in hidden" style="padding: 20px;">
        <h2 style="margin-bottom: 20px;">Request Item</h2>
        
        <a href="https://postimages.org/" target="_blank" class="upload-btn">
            <i class="fas fa-cloud-upload-alt"></i> Upload Image & Copy Direct Link
        </a>

        <input type="text" id="c-photo" class="auth-input" placeholder="Paste Image Link Here">
        <input type="text" id="c-name" class="auth-input" placeholder="Item Name">
        <input type="text" id="c-country" class="auth-input" placeholder="Your Country">

        <button class="btn btn-primary" onclick="submitCustom()">Submit Request</button>
    </div>

    <!-- 7. KEY VIEWER (Full Screen Overlay) -->
    <div id="view-key" class="key-popup hidden">
        <div class="key-card">
            <img id="k-logo" src="" style="width: 80px; height: 80px; border-radius: 20px; margin-bottom: 15px;">
            <h3 id="k-name" style="margin-bottom: 5px;">App Name</h3>
            <span class="tag" id="k-ver">v1.0</span>

            <div id="k-action-area" style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="handleKeyUnlock()">
                    <i class="fas fa-unlock"></i> UNLOCK NOW
                </button>
            </div>

            <div id="k-pass-area" class="hidden" style="margin-top: 20px;">
                <p style="font-size: 12px; color: var(--tg-hint);">PASSWORD</p>
                <div class="password-box" id="k-pass-txt">...</div>
                <button class="btn btn-outline" onclick="copyPass()">Copy</button>
            </div>

            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 30px;">
                <a id="k-yt" href="#" target="_blank" style="font-size: 28px; color: red;"><i class="fab fa-youtube"></i></a>
                <a id="k-tg" href="#" target="_blank" style="font-size: 28px; color: #0088cc;"><i class="fab fa-telegram"></i></a>
            </div>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAsw-zK0thQk-eXc5PeyIv99bTvrmoLvrQ",
            authDomain: "topup-store-28b23.firebaseapp.com",
            databaseURL: "https://topup-store-28b23-default-rtdb.firebaseio.com",
            projectId: "topup-store-28b23",
            storageBucket: "topup-store-28b23.firebasestorage.app",
            messagingSenderId: "869779143511",
            appId: "1:869779143511:web:222f95922961a9cf8a1c12",
            measurementId: "G-ZWTEG3NQEL"
        };

        // Init
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;

        // Globals
        let allItems = [];
        window.currentItem = null;
        window.currentKeyPage = null;

        // --- 2. STARTUP LOGIC ---
        window.onload = function() {
            tg.expand(); // Full Screen for Telegram
            
            // Check if opening a Key Page (?page=slug)
            const params = new URLSearchParams(window.location.search);
            const pageSlug = params.get('page');

            if(pageSlug) {
                // Open Key Viewer
                loadKeyPage(pageSlug);
                document.getElementById('loader').style.display = 'none';
                document.getElementById('nav-bar').style.display = 'none'; // Hide nav for key page
            } else {
                // Open Main App
                checkAuth();
            }
        };

        // --- 3. AUTHENTICATION ---
        function checkAuth() {
            // Priority: Telegram User
            if(tg.initDataUnsafe && tg.initDataUnsafe.user) {
                handleTelegramAuth(tg.initDataUnsafe.user);
            } else {
                // Fallback: Firebase Auth (Browser)
                auth.onAuthStateChanged(user => {
                    document.getElementById('loader').style.display = 'none';
                    if(user) {
                        initApp({ name: user.email, id: user.uid });
                    } else {
                        nav('auth');
                    }
                });
            }
        }

        async function handleTelegramAuth(tgUser) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('tg-login-status').classList.remove('hidden');
            document.getElementById('manual-login').classList.add('hidden');
            nav('auth'); // Show auth screen briefly

            try {
                // Save user to Firestore
                await db.collection('users').doc(String(tgUser.id)).set({
                    first_name: tgUser.first_name,
                    username: tgUser.username || '',
                    id: tgUser.id,
                    platform: 'telegram',
                    last_seen: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                initApp({ name: tgUser.first_name, id: tgUser.id });
            } catch (e) {
                console.error(e);
                // If error, let them login manually
                document.getElementById('tg-login-status').classList.add('hidden');
                document.getElementById('manual-login').classList.remove('hidden');
            }
        }

        function initApp(user) {
            // Update UI
            document.getElementById('header-name').innerText = user.name;
            document.getElementById('prof-name').innerText = user.name;
            document.getElementById('prof-id').innerText = "ID: " + user.id;

            loadSliders();
            loadItems();
            nav('home');
        }

        // Manual Auth Functions
        function manualLogin() {
            const e = document.getElementById('login-email').value;
            const p = document.getElementById('login-pass').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => Swal.fire('Error', err.message, 'error'));
        }
        function manualRegister() {
            const e = document.getElementById('reg-email').value;
            const p = document.getElementById('reg-pass').value;
            auth.createUserWithEmailAndPassword(e, p).catch(err => Swal.fire('Error', err.message, 'error'));
        }
        function toggleReg() {
            document.getElementById('manual-login').classList.toggle('hidden');
            document.getElementById('manual-reg').classList.toggle('hidden');
        }
        function logout() { auth.signOut(); location.reload(); }


        // --- 4. DATA LOADING ---
        async function loadItems() {
            const grid = document.getElementById('item-grid');
            grid.innerHTML = '<p style="text-align:center; width:200%;">Loading...</p>';

            db.collection('items').orderBy('created_at', 'desc').onSnapshot(snap => {
                allItems = [];
                grid.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    d.id = doc.id;
                    allItems.push(d);

                    const div = document.createElement('div');
                    div.className = 'card fade-in';
                    div.onclick = () => openDetails(d);
                    div.innerHTML = `
                        <img src="${d.thumb}" class="card-img">
                        <div class="card-content">
                            <div class="card-title">${d.title}</div>
                            <span class="tag">${d.version || 'New'}</span>
                        </div>
                    `;
                    grid.appendChild(div);
                });
                if(allItems.length === 0) grid.innerHTML = '<p>No items found.</p>';
            });
        }

        async function loadSliders() {
            const box = document.getElementById('slider-box');
            db.collection('sliders').get().then(snap => {
                let html = '';
                let i = 0;
                snap.forEach(doc => {
                    const s = doc.data();
                    html += `<img src="${s.img}" class="slide ${i===0?'active':''}" onclick="if('${s.link}') window.open('${s.link}')">`;
                    i++;
                });
                if(i>0) {
                    box.innerHTML = html;
                    setInterval(() => {
                        const slides = document.querySelectorAll('.slide');
                        let active = document.querySelector('.slide.active');
                        active.classList.remove('active');
                        if(active.nextElementSibling) active.nextElementSibling.classList.add('active');
                        else slides[0].classList.add('active');
                    }, 3000);
                }
            });
        }

        // --- 5. NAVIGATION ---
        function nav(viewId) {
            document.querySelectorAll('body > div[id^="view-"]').forEach(d => d.classList.add('hidden'));
            document.getElementById('view-' + viewId).classList.remove('hidden');
            
            // Update Bottom Nav
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(viewId === 'home') document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            if(viewId === 'custom') document.querySelector('.nav-item:nth-child(2)').classList.add('active');
            if(viewId === 'profile') document.querySelector('.nav-item:nth-child(3)').classList.add('active');
            
            // Show/Hide Nav Bar based on page
            const navBar = document.getElementById('nav-bar');
            if(['home', 'custom', 'profile'].includes(viewId)) navBar.classList.remove('hidden');
            else navBar.classList.add('hidden');
            
            window.scrollTo(0,0);
        }

        // --- 6. DETAILS & DOWNLOAD ---
        function openDetails(item) {
            window.currentItem = item;
            document.getElementById('dt-img').src = item.thumb;
            document.getElementById('dt-title').innerText = item.title;
            document.getElementById('dt-ver').innerText = item.version || 'v1.0';
            document.getElementById('dt-desc').innerText = item.description || 'No description.';
            nav('details');
        }

        function openPremium() {
            if(window.currentItem && window.currentItem.premiumLink) window.open(window.currentItem.premiumLink, '_blank');
            else Swal.fire('Info', 'Premium link not set', 'info');
        }

        function openDownloads() {
            const item = window.currentItem;
            if(!item) return;
            const con = document.getElementById('dl-btn-container');
            con.innerHTML = '';
            
            let btns = item.buttons || [];
            if(typeof btns === 'string') try { btns = JSON.parse(btns) } catch(e){ btns=[] }

            if(btns.length > 0) {
                btns.forEach(b => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-primary';
                    btn.innerHTML = `<i class="fas fa-cloud-download-alt"></i> ${b.label}`;
                    btn.onclick = () => handleSmartLink(item.smart_link, b.link, item.id, item.click_limit);
                    con.appendChild(btn);
                });
            } else {
                con.innerHTML = '<p>No free links available.</p>';
            }
            nav('downloads');
        }

        // SMART LINK LOGIC (MONEY SYSTEM)
        function handleSmartLink(smart, target, id, limit) {
            if(!smart) { window.open(target, '_blank'); return; }
            
            const key = 'sl_' + id;
            let count = parseInt(localStorage.getItem(key) || '0');
            const max = parseInt(limit) || 3;

            if(count < max) {
                localStorage.setItem(key, count + 1);
                window.open(smart, '_blank');
            } else {
                localStorage.setItem(key, 0); // Reset
                window.open(target, '_blank');
            }
        }

        // --- 7. KEY VIEWER ---
        async function loadKeyPage(slug) {
            document.querySelectorAll('body > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('view-key').classList.remove('hidden');

            const snap = await db.collection('key_pages').where('page_slug', '==', slug).get();
            if(snap.empty) {
                Swal.fire('Error', 'Invalid Page', 'error');
                return;
            }
            const d = snap.docs[0].data();
            window.currentKeyPage = d;

            document.getElementById('k-name').innerText = d.app_name;
            document.getElementById('k-logo').src = d.app_logo;
            document.getElementById('k-ver').innerText = 'v' + d.app_version;
            document.getElementById('k-yt').href = d.youtube_link;
            document.getElementById('k-tg').href = d.telegram_link;
        }

        async function handleKeyUnlock() {
            const d = window.currentKeyPage;
            // Smart Link Check
            if(d.smart_link) {
                let k = 'kp_' + d.page_slug;
                let c = parseInt(localStorage.getItem(k) || '0');
                if(c < (parseInt(d.click_target)||3)) {
                    localStorage.setItem(k, c+1);
                    window.open(d.smart_link, '_blank');
                    return;
                } else {
                    localStorage.setItem(k, 0);
                }
            }

            // Action
            if(d.download_link) {
                window.open(d.download_link, '_blank');
            } else if(d.sheet_id) {
                const btn = document.querySelector('#k-action-area button');
                btn.innerText = 'Verifying...';
                try {
                    const url = `https://docs.google.com/spreadsheets/d/${d.sheet_id}/gviz/tq?tqx=out:json`;
                    const res = await fetch(url);
                    const txt = await res.text();
                    const json = JSON.parse(txt.substring(47).slice(0, -2));
                    const pass = json.table.rows[0].c[0].v;
                    
                    document.getElementById('k-action-area').classList.add('hidden');
                    document.getElementById('k-pass-area').classList.remove('hidden');
                    document.getElementById('k-pass-txt').innerText = pass;
                } catch(e) {
                    Swal.fire('Error', 'Check Sheet ID', 'error');
                    btn.innerText = 'UNLOCK NOW';
                }
            }
        }

        function copyPass() {
            navigator.clipboard.writeText(document.getElementById('k-pass-txt').innerText);
            Swal.fire({icon:'success', title:'Copied', toast:true, position:'top', showConfirmButton:false, timer:1500});
        }

        // --- 8. CUSTOM REQUEST ---
        async function submitCustom() {
            const p = document.getElementById('c-photo').value;
            const n = document.getElementById('c-name').value;
            const c = document.getElementById('c-country').value;
            if(!p || !n || !c) return Swal.fire('Error', 'Fill all fields', 'warning');
            
            await db.collection('custom_submissions').add({
                photo_link: p, user_name: n, country: c, 
                created_at: firebase.firestore.FieldValue.serverTimestamp()
            });
            Swal.fire('Success', 'Request Sent!', 'success');
        }

        function filterItems() {
            const q = document.getElementById('search-input').value.toLowerCase();
            const grid = document.getElementById('item-grid');
            grid.innerHTML = '';
            allItems.filter(i => i.title.toLowerCase().includes(q)).forEach(d => {
                const div = document.createElement('div');
                div.className = 'card fade-in';
                div.onclick = () => openDetails(d);
                div.innerHTML = `
                    <img src="${d.thumb}" class="card-img">
                    <div class="card-content">
                        <div class="card-title">${d.title}</div>
                        <span class="tag">${d.version || 'New'}</span>
                    </div>
                `;
                grid.appendChild(div);
            });
        }
    </script>
</body>
</html>